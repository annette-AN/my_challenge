<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="css/font.css">
  <link rel="stylesheet" type="text/css" href="css/reset.css">
  <link rel="stylesheet" type="text/css" href="css/csBot.css">
  <title>chatting</title>
</head>

<body class="c_btm_hide"> <!-- [A] body.c-btm-hide (#connect_btm 없음) -->
<!-- connect_wrap -->
<div id="connect_wrap">
  <div class="connect_top">
    <div>
      <button type="button" class="chevron_prev text_hide">이전 페이지</button>
      <div class="title">
        <div class="subtitle align_center">
          <em>팬심</em>
        </div>
      </div>
    </div>
  </div>
  <!-- //connect_top -->
  <div id="content">
    <div class="cschat_body">
      <div class="cschat_mid">
        <ul class="cs_talk">
          <li class="bot">
            <div class="message">
              <div class="text">
                안녕하세요. 서비스센터입니다. 무엇을 도와드릴까요?
                <!-- [D] .btn_basic 태그 안에는 a와 button 모두 사용 가능합니다. -->
                <div class="btn_basic">
                  <a href="#none">버튼2</a>
                </div>
                안녕하세요. 서비스센터입니다. 무엇을 도와드릴까요?
                <div class="btn_basic">
                  <button type="button">버튼2버튼2버튼2버튼2</button>
                </div>
              </div>
              <div class="time">
                <span class="time">오전 12:20</span>
              </div>
            </div>
            <div class="btn_basic">
              <button type="button">버튼1</button>
              <button type="button">버튼2</button>
              <button type="button">버튼3</button>
              <a href="#none">a카테고리</a>
              <a href="#none">a카테고리</a>
              <a href="#none">a카테고리</a>
            </div>
          </li>
          <li class="user">
            <div class="message">
              <div class="text">
                안녕하세요. 서비스센터입니다. 무엇을 도와드릴까요?
              </div>
              <div class="time">
                <span class="time">오전 12:20</span>
              </div>
            </div>
          </li>
          <li class="date" id="chat_end_dt">
            <em>2020년 4월 6일 월요일</em>
          </li>
          <li class="system_entry">
            <em><span>홍길동</span> 님이 입장하셨습니다.</em>
          </li>
          <li class="bot">
            <div class="message">
              <div class="writing_effect">
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
              </div>
            </div>
          </li>
          <!-- <li class="each_chatout">
            <em>상담이 종료되었습니다.</em>
            <div class="supporter_evaluation">
              <div class="text_box">
                <em>
                  상담은 만족스러웠나요??
                </em>
                <p>
                  상담 평가를 남겨주시면 다음번 상담 시<br>
                  반영하도록 하겠습니다.
                </p>
              </div>
              <div class="suggestion">
                <div class="star_score">
                  <div class="score">
                    <button type="button"><em class="text_hide">5점 만점에 1점</em></button>
                    <span class="score_text">매우 불만족입니다.</span>
                  </div>
                  <div class="score">
                    <button type="button"><em class="text_hide">5점 만점에 2점</em></button>
                    <span class="score_text">만족스럽지 못해요.</span>
                  </div>
                  <div class="score">
                    <button type="button"><em class="text_hide">5점 만점에 3점</em></button>
                    <span class="score_text">무난무난, 보통이였습니다.</span>
                  </div>
                  <div class="score">
                    <button type="button"><em class="text_hide">5점 만점에 4점</em></button>
                    <span class="score_text">만족했어요.</span>
                  </div>
                  <div class="score">
                    <button type="button"><em class="text_hide">5점 만점에 5점</em></button>
                    <span class="score_text">와우! 매우 만족합니다.</span>
                  </div>
                </div>
                <textarea name="evaluation" id="" cols="30" rows="3" placeholder="추가 의견 작성하기"></textarea>
                <button type="submit" class="score_submit">완료</button>
              </div>
            </div>
          </li> -->
          <!-- <li class="each_chatout">
            <em>상담이 종료되었습니다.</em>
            <div class="star_score">
              <div class="score">
                <button type="button"><em class="text_hide">5점 만점에 1점</em></button>
                <span class="score_text">매우 불만족입니다.</span>
              </div>
              <div class="score">
                <button type="button"><em class="text_hide">5점 만점에 2점</em></button>
                <span class="score_text">만족스럽지 못해요.</span>
              </div>
              <div class="score">
                <button type="button"><em class="text_hide">5점 만점에 3점</em></button>
                <span class="score_text">무난무난, 보통이였습니다.</span>
              </div>
              <div class="score">
                <button type="button"><em class="text_hide">5점 만점에 4점</em></button>
                <span class="score_text">만족했어요.</span>
              </div>
              <div class="score">
                <button type="button"><em class="text_hide">5점 만점에 5점</em></button>
                <span class="score_text">와우! 매우 만족합니다.</span>
              </div>
            </div>
            <div class="btn_fill">
              <button type="button">상담 시작</button>
            </div>
          </li> -->

        </ul>
      </div>
      <!-- //cschat_mid -->
      <div class="cschat_btm">
        <div class="user_menu">
          <button type="button" class="menu_open"><em class="text_hide">메뉴 보기</em></button>
          <ul class="menu">
            <li><button type="button" id="btn_change">상담사 전환</button></li>
            <li><button type="button" id="btn_chatout">상담 종료</button></li>
          </ul>
        </div>
        <div class="user_writes">
          <textarea name="user_message" id="" rows="1" class="textbox_basic"></textarea>
          <button type="button" id="text_send" class="text_hide">글 남기기</button>
        </div>
      </div>
      <!-- //cschat_btm -->

      <!-- cs_chat 모달 -->
      <div class="modal">
        <!-- 상담원 전환 모달 -->
        <div class="basic_dialog dialog_change">
          <p>전문 상담사로<br>전환하시겠습니까?</p>
          <div class="btn_dual">
            <button type="button" class="btn_cancle">취소</button>
            <button type="button">연결</button>
          </div>
        </div>

        <!-- 상담 종료 모달 -->
        <div class="basic_dialog dialog_chatout">
          <p>상담을<br>종료하시겠습니까?</p>
          <div class="btn_dual">
            <button type="button" class="btn_cancle">취소</button>
            <button type="button" id="action_chatout">종료</button>
          </div>
        </div>
      </div>
    </div>
    <!-- //cschat_body -->
  </div>
  <!-- //content -->

  <div id="connect_btm">
    <div id="wrapper">
      <div class="lefe_side">
        <a href="home.html"><span class="fas fa-home"></span><em class="label">홈</em></a>
      </div>
      <div>
        <a href="chatting_list.html" class="chat_list"><span class="far fa-comment"></span><em class="text_hide">채팅 리스트 보기</em></a>
        <!-- [D] 총 메세지 수 표시
          모든 페이지에 적용되어야 합니다 -->
        <div class="new_message"><span class="text_hide">새로운 메세지 총</span><em class="message_num">8</em><span class="text_hide">개</span></div>
      </div>
      <div class="right_side">
        <a href="setting.html"><span class="fas fa-cog"></span><em class="label">설정</em></a>
      </div>
    </div>
  </div>
  <!-- //connect_btm -->

  <div class="score_templete hide">
    <div class="star_score">
      <div class="score">
        <button type="button"><em class="text_hide">5점 만점에 1점</em></button>
        <span class="score_text">매우 불만족입니다.</span>
      </div>
      <div class="score">
        <button type="button"><em class="text_hide">5점 만점에 2점</em></button>
        <span class="score_text">만족스럽지 못해요.</span>
      </div>
      <div class="score">
        <button type="button"><em class="text_hide">5점 만점에 3점</em></button>
        <span class="score_text">무난무난, 보통이였습니다.</span>
      </div>
      <div class="score">
        <button type="button"><em class="text_hide">5점 만점에 4점</em></button>
        <span class="score_text">만족했어요.</span>
      </div>
      <div class="score">
        <button type="button"><em class="text_hide">5점 만점에 5점</em></button>
        <span class="score_text">와우! 매우 만족합니다.</span>
      </div>
    </div>
  </div>
</div>
<!-- //connect_wrap -->
<script type="text/javascript" src="js/jQuery3.4.1.js"></script>
<script type="text/javascript" src="http://cdn.socket.io/socket.io-1.4.0.js"></script>
<!-- <script type="text/javascript" src="chat.js"></script> -->
<script type="text/javascript">
  $(document).ready(function () {

    handleCsTalkScoll();

    function checkbyte() {
      /* textarea height 길어지는 효과 */
      $('textarea[name="user_message"]').on("keydown", function () {
        var thisHeight = $(this).css('height').replace('px', '');
        var cschatMid = $('.cschat_mid');
        var cschatMidHeight = $('.cschat_mid').css('margin-bottom').replace('px', '');
        console.log(thisHeight)
        var byteTxt = "";
        var byte = function (str) {
          var byteNum = 0;
          for (i = 0; i < str.length; i++) {
            byteNum += (str.charCodeAt(i) > 127) ? 2 : 1;
            if (byteNum < 500) {
              byteTxt += str.charAt(i);
            };
          };
          return Math.round(byteNum);
        };

        if (byte($(this).val()) > 38) {
          alert("개행타임");
          $(this).val("");
          $(this).val(byteTxt);
          console.log(byte($(this).val(byteTxt)), 'byteTxt')

          $(this).css({ 'height': Number(thisHeight) + 40 + 'px' })
          cschatMid.css({ 'margin-bottom': Number(cschatMidHeight) + 40 + 'px' })
        } else {
          console.log(byte($(this).val()), 'byteval')
        }
      });
    }
    // checkbyte();

    /* 채팅 스크롤 하단 유지 */
    function handleCsTalkScoll() {
      var $csTalk = $('.cschat_mid .cs_talk');
      $csTalk.scrollTop($csTalk[0].scrollHeight);
    }

    /* 채팅 말풍선 생기기 */
    $('.user_writes #text_send').on('click', function () {
      var $textarea = $('textarea[name="user_message"]')
      var $csChatMid = $('.cschat_mid');
      var userMessage = $textarea.val();
      var botMessage = 'okey~';

      $('.cs_talk').append('<li class="user">\n' +
        '<div class="message">\n' +
        '<p class="text">\n' +
        userMessage +
        '</p>\n' +
        '</div>\n' +
        '</li>'
      ).append('<li class="bot">\n' +
        '<div class="message">\n' +
        '<p class="text">\n' +
        botMessage +
        '</p>\n' +
        '</div>\n' +
        '</li>'
      );
      userMessage = $textarea.val('');
      handleCsTalkScoll();
    });

    $('.cschat_btm .user_writes textarea[name="user_message"]').keyup(function (e) {
      e.preventDefault();
      // var chatMidHeight = $('.cschat_mid').height();
      // var txtHeight = $('textarea[name="user_message"]').height();
      var code = e.keyCode ? e.keyCode : e.which; if (code == 13) // EnterKey 

      var thisHeight = $(this).css('height').replace('px', '');
      var cschatMid = $('.cschat_mid');
      var cschatMidHeight = $('.cschat_mid').css('margin-bottom').replace('px', '');

      // {
      //   if (e.shiftKey === true) {
      //     // shift + Enter
      //     $(this).css({ 'height': Number(thisHeight) + 20 + 'px' })
      //     cschatMid.css({ 'margin-bottom': Number(cschatMidHeight) + 20 + 'px' })
      //   } else {
      //     // Enter
      //     $('.chatUI_btm #btn_chat').submit();
      //     $('.chatUI_btm .textArea').val('');
      //     $('.chatUI_mid').css({
      //       'height': '',
      //     });
      //     $('.chatUI_btm .textArea').css({
      //       'height': '',
      //     });
      //   }
      //   return false;
      // }
    });

    /* cschat_btm user메뉴 open */
    $('.cschat_btm .menu_open').on('click', function(){
      $(this).siblings('.menu').toggleClass('on');
    });

    /* cschat modal
    button 클릭 시 dialog 오픈 */
    function handleCschatDialog(button, dialog) {
      button.on('click', function () {
        $('.cschat_body').addClass('backdrop');
        dialog.addClass('on');
      });

      /* dialog 닫기 (취소버튼, 상담종료버튼) */
      dialog.find('.btn_cancle, #action_chatout').on('click', function () {
        /* 모달 전체 close 공통 */
        $('.cschat_body').removeClass('backdrop');
        dialog.removeClass('on');
        $('.menu').removeClass('on')
      })
    }
    handleCschatDialog($('#btn_change'), $('.dialog_change'));
    handleCschatDialog($('#btn_chatout'), $('.dialog_chatout'));


    /* 상담종료 시작부터 상담평가 완료까지의 이벤트 */
    function handleCschatChatend() {
      var starScoreEl = $('.score_templete').html();
      var $score = '';
      var $scoretext = '';
      var coloredScore = 0;
      var index = 0;

      // 상담 종료 버튼 클릭 시
      $('#action_chatout').on('click', function(){
        coloredScore = 0;

        // 상담 평가를 완료하지 않으면 menu 버튼 클릭 불가능
        $('.user_menu .menu button').attr('disabled',true);

        // 평가표 open
        $('.cs_talk').append(
          '<li class="each_chatout">'+
            '<div class="supporter_evaluation">'+
              '<div class="text_box">\n'+
                '<em>\n'+
                  '상담은 만족스러웠나요??\n'+
                '</em>\n'+
                '<p>\n'+
                  '상담 평가를 남겨주시면 다음번 상담 시<br>\n'+
                  '반영하도록 하겠습니다.\n'+
                '</p>\n'+
              '</div>\n'+
              '<div class="suggestion">\n'+
                starScoreEl +
                '\n<textarea name="evaluation" id="" cols="30" rows="3\n" placeholder="추가 의견 작성하기"></textarea>'+
                '<button type="submit" class="score_submit">완료</button>\n'+
              '</div>\n'+
            '</div>\n'+
          '</li>'
        );
        handleCsTalkScoll();
        scoreColoring();
        scoreSuccess();

      });

      // dialog 상담평가 별점주기
      function scoreColoring() {
        $('.supporter_evaluation .score button').on('click', function () {
          $score = $('.supporter_evaluation .score');
          thisScore = $(this).parent($('.score'));
          $scoretext = $score.find($('.score_text'));
          index = $score.index(thisScore);
          coloredScore = index + 1;

          actionColoring();
        });
      }

      // 평가 결과 채팅창에 표시
      function scoreSuccess(){
        $('.score_submit').on('click', function(){
          $('.each_chatout').empty().html(
            '<em>상담이 종료되었습니다.</em>\n' +
            '<div class="selected_score">\n' + starScoreEl + '\n</div>' + 
            '<div class="btn_fill">\n' +
              '<button type="button">상담 시작</button>\n' +
            '</div>'
          );

          $score = $('.selected_score').find('.score');
          $scoretext = $score.find($('.score_text'));
          coloredScore = index + 1;

          $scoretext.addClass('hide');
          actionColoring()

          // 상담 평가를 완료하면 menu 버튼 클릭 가능
          $('.user_menu .menu button').attr('disabled',false);
        });
      }

      // 클릭한 별만큼 색칠하기
      function actionColoring() {
        $score.removeClass('on');
        $scoretext.removeClass('on');
        for (var i = 0; i < coloredScore; i++) {
          $score.eq(i).addClass('on');
        }
        $scoretext.eq(index).addClass('on');
      }
    }
    handleCschatChatend();
    
  })
</script>
</body>

</html>